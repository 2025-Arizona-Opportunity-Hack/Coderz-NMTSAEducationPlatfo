{% extends "base.html" %}
{% load static %}

{% block title %}Discussions - {{ course.title }}{% endblock %}

{% block content %}
<div>
    <!-- Breadcrumb -->
    <nav style="display:flex; align-items:center; gap:8px; color: var(--text-secondary); font-size: calc(0.875rem * var(--font-scale)); margin-bottom: var(--spacing-lg);">
        <a href="{% url 'student_dashboard' %}" style="color: inherit; text-decoration: none;">Dashboard</a>
        <span style="color: var(--text-muted);">›</span>
        <a href="{% url 'student_course_detail' course.id %}" style="color: inherit; text-decoration: none;">{{ course.title|truncatewords:3 }}</a>
        <span style="color: var(--text-muted);">›</span>
        <span style="color: var(--text-primary); font-weight: 600;">Discussions</span>
    </nav>

    <!-- Header -->
    <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom: var(--spacing-xl);">
        <h2 style="margin:0;">Course Discussions</h2>
        <a href="{% url 'student_discussion_create' course.id %}" class="btn btn-primary">Start Discussion</a>
    </div>

    <!-- Filters and Sorting -->
    <div class="card" style="margin-bottom: var(--spacing-lg);">
        <form method="get" style="display:flex; flex-wrap:wrap; gap: var(--spacing-sm); align-items:center;">
            <div style="flex:1; min-width: 240px; position: relative;">
                <input type="text" name="q" value="{{ request.GET.q|default:'' }}" placeholder="Search discussions..." style="width:100%; padding: 10px 12px; padding-left: 36px; border:1px solid var(--border-color); border-radius: 8px;" />
                <svg width="16" height="16" style="position:absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            <div style="display:flex; gap: 8px;">
                <a href="?sort=latest{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="btn btn-outline btn-sm{% if sort == 'latest' or not sort %} is-active{% endif %}">Latest</a>
                <a href="?sort=popular{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="btn btn-outline btn-sm{% if sort == 'popular' %} is-active{% endif %}">Popular</a>
                <a href="?sort=unanswered{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="btn btn-outline btn-sm{% if sort == 'unanswered' %} is-active{% endif %}">Unanswered</a>
            </div>
        </form>
    </div>

    <!-- Discussions List -->
    {% if posts.object_list %}
        <div style="display:flex; flex-direction:column; gap: var(--spacing-md);">
            {% for d in posts %}
            <a href="{% url 'student_discussion_detail' course.id d.id %}" class="card" style="text-decoration:none; color: inherit;">
                <div style="display:flex; align-items:center; justify-content: space-between; gap: var(--spacing-md); margin-bottom: 6px;">
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        {% if d.is_pinned %}
                        <span style="padding:2px 8px; background:#FFF8E1; color:#B58900; border:1px solid #F3E5AB; border-radius:999px; font-size:11px; font-weight:700;">Pinned</span>
                        {% endif %}
                        <h3 style="margin:0; font-size:1rem;">{{ d.title }}</h3>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px; color: var(--text-secondary); font-size:12px;">
                        <span>{{ d.get_reply_count }} replies</span>
                        <span>{{ d.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                <p style="margin:0; color: var(--text-secondary); max-height: 3.2em; overflow: hidden;">{{ d.content }}</p>
            </a>
            {% endfor %}
        </div>

        {% if paginator.num_pages > 1 %}
        <div style="display:flex; align-items:center; justify-content: space-between; margin-top: var(--spacing-lg);">
            <div style="color: var(--text-secondary); font-size: 12px;">Page {{ posts.number }} of {{ paginator.num_pages }}</div>
            <div style="display:flex; gap:8px;">
                {% if posts.has_previous %}
                <a href="?page={{ posts.previous_page_number }}{% if sort %}&sort={{ sort }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="btn btn-outline btn-sm">Previous</a>
                {% endif %}
                {% if posts.has_next %}
                <a href="?page={{ posts.next_page_number }}{% if sort %}&sort={{ sort }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="btn btn-outline btn-sm">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="card" style="text-align:center;">
            <p style="margin:0 0 8px 0; font-weight:600;">No discussions yet</p>
            <p style="margin:0; color: var(--text-secondary);">Start the first discussion to get the conversation going!</p>
            <div style="margin-top: var(--spacing-md);">
                <a href="{% url 'student_discussion_create' course.id %}" class="btn btn-primary">Start Discussion</a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

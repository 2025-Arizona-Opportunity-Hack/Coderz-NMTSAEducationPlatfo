{% load static %}

<nav class="navbar" style="display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: var(--spacing-lg);">
        <!-- Brand/Logo -->
        <a href="/" class="navbar-brand" style="text-decoration: none;">
            NMTSA Learning
        </a>

        <!-- Main Navigation Links -->
        <div class="navbar-menu" style="display: flex; gap: var(--spacing-md);">
            {% if request.session.user %}
                <!-- Authenticated User Menu -->
                {% if request.session.user.role == 'admin' %}
                    <a href="{% url 'admin_dashboard' %}" class="nav-link {% if '/admin-dash/' in request.path %}active{% endif %}">
                        Admin Dashboard
                    </a>
                {% endif %}

                {% if request.session.user.role == 'teacher' %}
                    <a href="{% url 'teacher_dashboard' %}" class="nav-link {% if '/teacher/' in request.path %}active{% endif %}">
                        Teacher Dashboard
                    </a>
                {% endif %}

                {% if request.session.user.role == 'student' %}
                    <a href="{% url 'student_courses' %}" class="nav-link {% if '/student/courses/' in request.path %}active{% endif %}">
                        My Courses
                    </a>

                    <a href="{% url 'student_catalog' %}" class="nav-link {% if '/student/catalog/' in request.path %}active{% endif %}">
                        Browse Courses
                    </a>
                {% endif %}
            {% else %}
                <!-- Guest User Menu -->
                <a href="/#about" class="nav-link {% if request.path == '/#about' %}active{% endif %}">
                    About
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Right Side Menu -->
    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
        <!-- Settings Button -->
        <button onclick="openSettings()"
                class="settings-nav-btn"
                style="display: flex; align-items: center; gap: var(--spacing-xs); padding: var(--spacing-sm) var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-secondary); cursor: pointer; transition: all 0.2s; min-height: 40px;"
                aria-label="Open settings"
                title="Adjust theme, font size, language and more">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6m8.66-16.5-3 5.2M6.34 14.3l-3 5.2M23 12h-6M7 12H1m15.66 8.5-3-5.2M6.34 9.7l-3-5.2"/>
            </svg>
        </button>

        {% if request.user.is_authenticated or request.session.user %}
            <!-- User Profile Dropdown -->
            <div style="position: relative;">
            <button onclick="toggleUserMenu()"
                id="user-menu-btn"
                style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm) var(--spacing-md); border: 2px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); cursor: pointer; min-height: 40px;"
                aria-label="User menu"
                aria-expanded="false">
                {% with u=request.session.user %}
                {% if u and 'userinfo' in u and u.userinfo.picture %}
                    <img src="{{ u.userinfo.picture }}" alt="Profile" style="width: 24px; height: 24px; border-radius: 50%;">
                {% else %}
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                    </svg>
                {% endif %}

                {% if u and 'userinfo' in u %}
                    <span>{{ u.full_name|default:u.userinfo.name|default:"User" }}</span>
                {% else %}
                    <span>{{ request.user.get_full_name|default:request.user.username|default:"User" }}</span>
                {% endif %}
                {% endwith %}
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"/>
                </svg>
            </button>

            <!-- Dropdown Menu (Hidden by default) -->
            <div id="user-menu"
                 style="display: none; position: absolute; right: 0; top: 48px; min-width: 220px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 6px; padding: var(--spacing-sm); z-index: 150; box-shadow: var(--shadow-lg);">

                <!-- Role Badge -->
                <div style="padding: var(--spacing-sm) var(--spacing-md); margin-bottom: var(--spacing-sm);">
                <p style="font-size: calc(0.75rem * var(--font-scale)); color: var(--text-secondary); margin: 0 0 var(--spacing-xs) 0;">
                    Signed in as
                </p>
                <p style="font-weight: 600; color: var(--text-primary); margin: 0;">
                    {% if request.session.user.role == 'student' %}
                    Student
                    {% elif request.session.user.role == 'teacher' %}
                    {% if request.session.user.verification_status == 'pending' %}
                        Teacher (Pending)
                    {% elif request.session.user.verification_status == 'approved' %}
                        Teacher âœ“
                    {% else %}
                        Teacher
                    {% endif %}
                    {% elif request.session.user.role == 'admin' or request.user.is_staff %}
                    Administrator
                    {% else %}
                    User
                    {% endif %}
                </p>
                </div>

                <hr style="margin: var(--spacing-sm) 0; border: none; border-top: 1px solid var(--border-color);">

                <a href="{% url 'profile_settings' %}" style="display: block; padding: var(--spacing-sm) var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 4px;">
                Profile Settings
                </a>

                {% if request.session.user.role == 'student' %}
                <a href="{% url 'student_dashboard' %}" style="display: block; padding: var(--spacing-sm) var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 4px;">
                My Dashboard
                </a>
                {% elif request.session.user.role == 'teacher' %}
                <a href="{% url 'teacher_dashboard' %}" style="display: block; padding: var(--spacing-sm) var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 4px;">
                Teacher Dashboard
                </a>
                {% elif request.session.user.role == 'admin' or request.user.is_staff %}
                <a href="{% url 'admin_dashboard' %}" style="display: block; padding: var(--spacing-sm) var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 4px;">
                Admin Dashboard
                </a>
                {% endif %}

                <hr style="margin: var(--spacing-sm) 0; border: none; border-top: 1px solid var(--border-color);">
                {% if request.user.is_authenticated %}
                <a href="{% url 'admin_logout' %}" style="display: block; padding: var(--spacing-sm) var(--spacing-md); text-decoration: none; color: #D9A8A8; border-radius: 4px;">
                Logout
                </a>
                {% else %}
                <a href="{% url 'logout' %}" style="display: block; padding: var(--spacing-sm) var(--spacing-md); text-decoration: none; color: #D9A8A8; border-radius: 4px;">
                Logout
                </a>
                {% endif %}
            </div>
            </div>
        {% else %}
            <!-- Guest User Buttons -->
            <a href="{% url 'login' %}" class="btn btn-outline btn-sm">
            Login
            </a>
        {% endif %}
    </div>
</nav>

<script>
    // Toggle user menu dropdown (click-based, not hover)
    function toggleUserMenu() {
        const menu = document.getElementById('user-menu');
        const btn = document.getElementById('user-menu-btn');
        const isHidden = menu.style.display === 'none';

        menu.style.display = isHidden ? 'block' : 'none';
        btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    }

    // Close user menu when clicking outside
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('user-menu');
        const btn = document.getElementById('user-menu-btn');

        if (menu && btn && !menu.contains(event.target) && !btn.contains(event.target)) {
            menu.style.display = 'none';
            btn.setAttribute('aria-expanded', 'false');
        }
    });
</script>

<style>
    /* Settings button hover effect */
    .settings-nav-btn:hover {
        border-color: var(--primary) !important;
        background: var(--primary-light) !important;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .settings-nav-btn:active {
        transform: translateY(0);
    }
</style>

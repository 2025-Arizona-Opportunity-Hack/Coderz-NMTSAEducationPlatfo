{% extends 'base.html' %}

{% block title %}{{ course.title }} - NMTSA Learning{% endblock %}

{% block description %}{{ course.description|truncatewords:30|striptags }}{% endblock %}

{% block keywords %}neurologic music therapy, {{ course.title }}, {% for tag in course.tags.all %}{{ tag.name }}, {% endfor %}autism therapy, music therapy course{% endblock %}

{% block og_title %}{{ course.title }} - NMTSA Learning{% endblock %}
{% block og_description %}{{ course.description|truncatewords:30|striptags }}{% endblock %}

{% block extra_head %}
<!-- Schema.org structured data for Course -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Course",
  "name": "{{ course.title|escapejs }}",
  "description": "{{ course.description|escapejs|truncatewords:50 }}",
  "provider": {
    "@type": "Organization",
    "name": "NMTSA Learning"
  },
  "instructor": {
    "@type": "Person",
    "name": "{{ course.published_by.get_full_name|escapejs }}"
  },
  {% if course.is_paid %}
  "offers": {
    "@type": "Offer",
    "price": "{{ course.price }}",
    "priceCurrency": "USD"
  },
  {% endif %}
  "educationalLevel": "Professional Development",
  "courseMode": "Online",
  "numberOfLessons": "{{ total_lessons }}",
  "timeRequired": "PT{{ total_duration }}M"
}
</script>
{% endblock %}

{% block content %}
<div style="display: flex; gap: var(--spacing-xl);">
    <!-- Simple Navigation -->
    <nav style="width: 250px; min-height: calc(100vh - 200px); background: var(--bg-card); border-right: 1px solid var(--border-color); padding: var(--spacing-lg);">
        <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="margin-bottom: var(--spacing-sm);">
                <a href="/student/" style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 6px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
            </li>
            <li style="margin-bottom: var(--spacing-sm);">
                <a href="/student/courses/" style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 6px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    <span>My Courses</span>
                </a>
            </li>
            <li style="margin-bottom: var(--spacing-sm);">
                <a href="/student/catalog/" style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); text-decoration: none; color: #7FA8C9; border-radius: 6px; background: #E8F1F8; font-weight: 600;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <span>Browse Catalog</span>
                </a>
            </li>
            <li style="margin-bottom: var(--spacing-sm);">
                <a href="/auth/profile/settings/" style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 6px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6m8.66-10a9 9 0 0 1 0 8m-17.32 0a9 9 0 0 1 0-8"/>
                    </svg>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div style="flex: 1; max-width: 1000px;">
        <!-- Back Link -->
        <a href="{% if is_public_view %}{% url 'public_catalog' %}{% else %}{% url 'student_catalog' %}{% endif %}"
           style="display: inline-flex; align-items: center; gap: var(--spacing-sm); color: var(--text-secondary); text-decoration: none; margin-bottom: var(--spacing-lg); font-size: calc(0.875rem * var(--font-scale)); transition: color 0.2s;">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="m15 18-6-6 6-6"/>
            </svg>
            Back to Catalog
        </a>

        <!-- Course Header -->
        <div style="background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-color); overflow: hidden; margin-bottom: var(--spacing-xl); box-shadow: var(--shadow-md);">
            <!-- Course Banner -->
            <div style="width: 100%; height: 300px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
                <!-- Price Badge -->
                <div style="position: absolute; top: var(--spacing-lg); right: var(--spacing-lg); background: white; padding: 12px 20px; border-radius: var(--radius-md); font-weight: 700; font-size: calc(1.25rem * var(--font-scale)); box-shadow: var(--shadow-lg);">
                    {% if course.price == 0 %}
                        <span style="color: #66BB6A;">FREE</span>
                    {% else %}
                        <span style="color: var(--primary);">${{ course.price }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Course Info -->
            <div style="padding: var(--spacing-2xl);">
                <h1 style="margin-bottom: var(--spacing-md); font-size: calc(2rem * var(--font-scale));">
                    {{ course.title }}
                </h1>

                <!-- Meta Info -->
                <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xl); margin-bottom: var(--spacing-xl); color: var(--text-secondary); font-size: calc(0.875rem * var(--font-scale));">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="7" r="4"/>
                            <path d="M5 21v-2a7 7 0 0 1 14 0v2"/>
                        </svg>
                        <strong>Instructor:</strong>&nbsp;{{ course.published_by.get_full_name }}
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                        <strong>{{ course.num_enrollments }}</strong>&nbsp;students enrolled
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Published {{ course.published_date|date:"M d, Y" }}
                    </div>
                </div>

                <!-- Enrollment Status / Action -->
                {% if is_enrolled %}
                    <!-- Already Enrolled -->
                    <div style="background: #E8F5E9; border: 2px solid #66BB6A; border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-lg);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                                <svg width="24" height="24" fill="none" stroke="#66BB6A" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                <div>
                                    <div style="font-weight: 600; color: #2E7D32; margin-bottom: 4px;">You're enrolled in this course</div>
                                    {% if enrollment %}
                                        {% if not enrollment.completed_at %}
                                        <div style="color: #558B2F; font-size: calc(0.875rem * var(--font-scale));">
                                            {{ enrollment.progress_percentage }}% complete
                                        </div>
                                        {% else %}
                                        <div style="color: #558B2F; font-size: calc(0.875rem * var(--font-scale));">
                                            Completed on {{ enrollment.completed_at|date:"M d, Y" }}
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <a href="{% url 'student_learning' course.slug %}"
                               style="padding: var(--spacing-md) var(--spacing-xl); background: #66BB6A; color: white; border-radius: var(--radius-md); text-decoration: none; font-weight: 600; white-space: nowrap;">
                                {% if enrollment and enrollment.completed_at %}
                                    Review Course
                                {% else %}
                                    Continue Learning
                                {% endif %}
                            </a>
                        </div>
                    </div>
                {% elif is_authenticated %}
                    <!-- Authenticated but not enrolled - Show enroll button -->
                    <form method="POST" action="{% url 'student_enroll' course.slug %}">
                        {% csrf_token %}
                        <button type="submit"
                                style="width: 100%; padding: var(--spacing-lg); background: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-size: calc(1.125rem * var(--font-scale)); font-weight: 600; cursor: pointer; transition: opacity 0.2s; margin-bottom: var(--spacing-lg);">
                            {% if course.is_paid %}
                                Enroll Now - ${{ course.price }}
                            {% else %}
                                Enroll for Free
                            {% endif %}
                        </button>
                    </form>
                {% else %}
                    <!-- Anonymous user - Show sign in to enroll -->
                    <div style="background: #FFF3E0; border: 2px solid #FF9800; border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); text-align: center;">
                        <p style="color: #E65100; font-weight: 600; margin-bottom: var(--spacing-md);">
                            Sign in to enroll in this course
                        </p>
                        <a href="{% url 'login' %}?next={{ request.path }}"
                           style="display: inline-block; padding: var(--spacing-md) var(--spacing-2xl); background: var(--primary); color: white; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">
                            Sign In to Enroll
                        </a>
                    </div>
                {% endif %}

                <!-- Discussions Link (for enrolled students only) -->
                {% if is_enrolled %}
                <div style="margin-top: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <a href="{% url 'student_course_discussions' course.slug %}"
                       style="display: inline-flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-md) var(--spacing-lg); background: #F3F4F6; color: var(--text-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); text-decoration: none; font-weight: 600; transition: background-color 0.2s;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span>Course Discussions</span>
                    </a>
                </div>
                {% endif %}

                <!-- Tags -->
                {% if course.tags.all %}
                <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                    {% for tag in course.tags.all %}
                    <span style="background: var(--bg-secondary); color: var(--text-secondary); padding: 6px 14px; border-radius: var(--radius-md); font-size: calc(0.875rem * var(--font-scale)); border: 1px solid var(--border-color);">
                        {{ tag.name }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Course Description -->
        <div style="background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: var(--spacing-2xl); margin-bottom: var(--spacing-xl);">
            <h2 style="margin-bottom: var(--spacing-lg); font-size: calc(1.5rem * var(--font-scale));">About This Course</h2>
            <p style="color: var(--text-primary); line-height: 1.8; font-size: calc(1rem * var(--font-scale)); white-space: pre-line;">{{ course.description }}</p>
        </div>

        <!-- Course Content / Modules -->
        {% if modules %}
        <div style="background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: var(--spacing-2xl); margin-bottom: var(--spacing-xl);">
            <h2 style="margin-bottom: var(--spacing-lg); font-size: calc(1.5rem * var(--font-scale));">Course Content</h2>

            <div style="display: flex; gap: var(--spacing-xl); margin-bottom: var(--spacing-xl); color: var(--text-secondary); font-size: calc(0.875rem * var(--font-scale));">
                <span>{{ modules|length }} modules</span>
                <span>{{ total_lessons|default:0 }} lessons</span>
            </div>

            <!-- Modules List -->
            <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                {% for module in modules %}
                <details style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-lg);">
                    <summary style="cursor: pointer; font-weight: 600; font-size: calc(1.125rem * var(--font-scale)); list-style: none; display: flex; justify-content: space-between; align-items: center;">
                        <span>{{ forloop.counter }}. {{ module.title }}</span>
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="transition: transform 0.2s;">
                            <path d="m6 9 6 6 6-6"/>
                        </svg>
                    </summary>

                    <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md); line-height: 1.6;">
                            {{ module.description }}
                        </p>

                        <!-- Lessons in Module -->
                        {% if module.lessons.all %}
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% for lesson in module.lessons.all %}
                            <li style="padding: var(--spacing-sm) 0; display: flex; align-items: center; gap: var(--spacing-md); color: var(--text-secondary); font-size: calc(0.875rem * var(--font-scale));">
                                <!-- Lesson Icon -->
                                {% if lesson.lesson_type == 'video' %}
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                {% else %}
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                {% endif %}

                                <span{% if not is_enrolled %} style="opacity: 0.6;"{% endif %}>{{ lesson.title }}</span>
                                
                                {% if not is_enrolled %}
                                    <!-- Lock icon for non-enrolled users -->
                                    <svg width="14" height="14" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24" style="margin-left: auto;">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                    </svg>
                                {% else %}
                                    <span style="margin-left: auto; color: var(--text-muted);">{{ lesson.duration }} min</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p style="color: var(--text-muted); font-style: italic;">No lessons in this module yet.</p>
                        {% endif %}
                    </div>
                </details>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Instructor Info -->
        <div style="background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: var(--spacing-2xl);">
            <h2 style="margin-bottom: var(--spacing-lg); font-size: calc(1.5rem * var(--font-scale));">About the Instructor</h2>

            <div style="display: flex; align-items: start; gap: var(--spacing-lg);">
                <!-- Instructor Avatar -->
                <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: calc(2rem * var(--font-scale)); font-weight: 700; flex-shrink: 0;">
                    {{ course.published_by.first_name.0 }}{{ course.published_by.last_name.0 }}
                </div>

                <div>
                    <h3 style="margin-bottom: var(--spacing-sm); font-size: calc(1.25rem * var(--font-scale));">
                        {{ course.published_by.get_full_name }}
                    </h3>

                    {% if course.published_by.teacher_profile %}
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                        {{ course.published_by.teacher_profile.specialization|default:"Professional Educator" }}
                    </p>

                    {% if course.published_by.teacher_profile.bio %}
                    <p style="color: var(--text-primary); line-height: 1.6;">
                        {{ course.published_by.teacher_profile.bio }}
                    </p>
                    {% endif %}

                    {% if course.published_by.teacher_profile.years_experience %}
                    <p style="color: var(--text-secondary); margin-top: var(--spacing-sm); font-size: calc(0.875rem * var(--font-scale));">
                        {{ course.published_by.teacher_profile.years_experience }} years of experience
                    </p>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Rotate arrow on details toggle
document.addEventListener('DOMContentLoaded', () => {
    const details = document.querySelectorAll('details');

    details.forEach(detail => {
        detail.addEventListener('toggle', () => {
            const svg = detail.querySelector('summary svg');
            if (detail.open) {
                svg.style.transform = 'rotate(180deg)';
            } else {
                svg.style.transform = 'rotate(0deg)';
            }
        });
    });
});
</script>
{% endblock %}

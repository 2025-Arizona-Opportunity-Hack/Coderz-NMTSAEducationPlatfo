{% extends 'base.html' %}

{% block title %}Course Catalog - NMTSA Learning{% endblock %}

{% block description %}Browse our comprehensive collection of neurologic music therapy courses. Professional education for autism support, healthcare professionals, and families.{% endblock %}

{% block keywords %}neurologic music therapy courses, NMT certification, autism therapy courses, music therapy education, professional development courses, healthcare education online{% endblock %}

{% block og_title %}Course Catalog - NMTSA Learning{% endblock %}
{% block og_description %}Browse our comprehensive collection of neurologic music therapy courses for professionals and families.{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Browse Courses</h1>
    <p class="page-description">Explore our comprehensive collection of neurologic music therapy courses</p>
</div>

<div style="display: grid; grid-template-columns: 250px 1fr; gap: var(--spacing-xl);">
    <!-- Filters Sidebar (Inline and Non-Recursive) -->
    <aside style="background: var(--bg-card); padding: var(--spacing-lg); border-radius: 8px; border: 1px solid var(--border-color); height: fit-content;">
        <h2 style="font-size: calc(1.25rem * var(--font-scale)); margin-top: 0;">Filters</h2>

        <form method="get" id="filter-form">
            <!-- Preserve search query -->
            {% if filters.q %}
                <input type="hidden" name="q" value="{{ filters.q }}">
            {% endif %}

            <!-- Price Filter -->
            <div style="margin-bottom: var(--spacing-xl);">
                <h3 style="font-size: calc(1rem * var(--font-scale)); margin-bottom: var(--spacing-md);">Price</h3>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="price" value="free" style="width: 20px; height: 20px;" 
                               {% if 'free' in filters.price_types %}checked{% endif %}>
                        <span>Free Courses</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="price" value="paid" style="width: 20px; height: 20px;"
                               {% if 'paid' in filters.price_types %}checked{% endif %}>
                        <span>Paid Courses</span>
                    </label>
                </div>
            </div>

            <!-- Category Filter -->
            <div style="margin-bottom: var(--spacing-xl);">
                <h3 style="font-size: calc(1rem * var(--font-scale)); margin-bottom: var(--spacing-md);">Category</h3>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="category" value="therapy" style="width: 20px; height: 20px;"
                               {% if 'therapy' in filters.categories %}checked{% endif %}>
                        <span>Therapy Techniques</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="category" value="family" style="width: 20px; height: 20px;"
                               {% if 'family' in filters.categories %}checked{% endif %}>
                        <span>Family Support</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="category" value="professional" style="width: 20px; height: 20px;"
                               {% if 'professional' in filters.categories %}checked{% endif %}>
                        <span>Professional Development</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="category" value="certification" style="width: 20px; height: 20px;"
                               {% if 'certification' in filters.categories %}checked{% endif %}>
                        <span>Certification Programs</span>
                    </label>
                </div>
            </div>

            <!-- Duration Filter -->
            <div style="margin-bottom: var(--spacing-xl);">
                <h3 style="font-size: calc(1rem * var(--font-scale)); margin-bottom: var(--spacing-md);">Duration</h3>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="duration" value="short" style="width: 20px; height: 20px;"
                               {% if 'short' in filters.durations %}checked{% endif %}>
                        <span>Under 2 hours</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="duration" value="medium" style="width: 20px; height: 20px;"
                               {% if 'medium' in filters.durations %}checked{% endif %}>
                        <span>2-5 hours</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" name="duration" value="long" style="width: 20px; height: 20px;"
                               {% if 'long' in filters.durations %}checked{% endif %}>
                        <span>5+ hours</span>
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: var(--spacing-md);">
                Apply Filters
            </button>
        </form>

        <a href="{% url 'public_catalog' %}" class="btn btn-outline" style="width: 100%; text-decoration: none; display: inline-block; text-align: center;">
            Clear All Filters
        </a>
    </aside>

    <!-- Courses Grid -->
    <main>
        <!-- Search Bar -->
        <div style="margin-bottom: var(--spacing-xl);">
            <form method="get" action="{% url 'public_catalog' %}">
                <div style="position: relative;">
                    <input type="search"
                           name="q"
                           placeholder="Search courses by title or description..."
                           class="form-input"
                           style="padding-left: 48px;"
                           value="{{ filters.q }}">
                    <svg width="20" height="20" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24" style="position: absolute; left: 16px; top: 14px;">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </div>
            </form>
        </div>

        <!-- Results Count -->
        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
            Showing {{ courses|length }} course{{ courses|length|pluralize }}
        </p>

        <!-- Courses Grid -->
        {% if courses %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--spacing-lg);">
            {% for course in courses %}
            <div class="card">
                {% if course.image %}
                <img src="{{ course.image }}" alt="{{ course.title }}" style="width: 100%; height: 180px; object-fit: cover; border-radius: 6px; margin-bottom: var(--spacing-md);">
                {% else %}
                <div style="width: 100%; height: 180px; background: linear-gradient(135deg, #E8F1F8 0%, #D9E8F4 100%); border-radius: 6px; margin-bottom: var(--spacing-md); display: flex; align-items: center; justify-content: center;">
                    <svg width="64" height="64" fill="none" stroke="#7FA8C9" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                </div>
                {% endif %}

                <h3 style="margin-top: 0; margin-bottom: var(--spacing-sm);">
                    <a href="{% if is_public_view %}{% url 'public_course_detail' course.slug %}{% else %}{% url 'student_course_detail' course.slug %}{% endif %}" 
                       style="text-decoration: none; color: var(--text-primary);">
                        {{ course.title }}
                    </a>
                </h3>

                <p style="color: var(--text-secondary); font-size: calc(0.875rem * var(--font-scale)); margin-bottom: var(--spacing-md);">
                    {{ course.description|truncatewords:20 }}
                </p>

                <!-- Course Meta -->
                <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md); flex-wrap: wrap;">
                    <span style="color: var(--text-muted); font-size: calc(0.875rem * var(--font-scale)); display: flex; align-items: center; gap: 4px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        </svg>
                        {{ course.modules.count }} modules
                    </span>
                    <span style="color: var(--text-muted); font-size: calc(0.875rem * var(--font-scale)); display: flex; align-items: center; gap: 4px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                        {{ course.num_enrollments }} students
                    </span>
                </div>

                <!-- Price and Action Button -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                    <span style="font-size: calc(1.25rem * var(--font-scale)); font-weight: 600; color: var(--text-primary);">
                        {% if course.is_paid %}
                            ${{ course.price }}
                        {% else %}
                            <span style="color: #66BB6A;">Free</span>
                        {% endif %}
                    </span>
                    
                    {% if course.user_enrolled %}
                        <!-- Enrolled - Continue learning -->
                        <a href="{% url 'student_learning' course.slug %}" 
                           class="btn btn-sm"
                           style="padding: 8px 16px; background: #66BB6A; color: white; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: calc(0.875rem * var(--font-scale));">
                            Continue Learning
                        </a>
                    {% elif request.is_authenticated_user %}
                        <!-- Authenticated but not enrolled -->
                        <a href="{% if is_public_view %}{% url 'public_course_detail' course.slug %}{% else %}{% url 'student_course_detail' course.slug %}{% endif %}" 
                           class="btn btn-primary btn-sm"
                           style="padding: 8px 16px; background: var(--primary); color: white; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: calc(0.875rem * var(--font-scale));">
                            View Course
                        </a>
                    {% else %}
                        <!-- Anonymous user -->
                        <a href="{% url 'login' %}?next={% if is_public_view %}{% url 'public_course_detail' course.slug %}{% else %}{% url 'student_course_detail' course.slug %}{% endif %}" 
                           class="btn btn-sm"
                           style="padding: 8px 16px; background: var(--primary); color: white; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: calc(0.875rem * var(--font-scale));">
                            Sign In to Enroll
                        </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info" style="text-align: center; padding: var(--spacing-2xl);">
            <svg width="64" height="64" fill="none" stroke="#7FA8C9" stroke-width="2" viewBox="0 0 24 24" style="margin: 0 auto var(--spacing-lg);">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <h3>No courses found</h3>
            <p>Try adjusting your filters or search query</p>
        </div>
        {% endif %}
    </main>
</div>

<script>
// Add hover effect to cards
document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.card');

    cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            card.style.transform = 'translateY(-4px)';
            card.style.boxShadow = 'var(--shadow-lg)';
        });

        card.addEventListener('mouseleave', () => {
            card.style.transform = 'translateY(0)';
            card.style.boxShadow = 'var(--shadow-sm)';
        });
    });
});
</script>
{% endblock %}

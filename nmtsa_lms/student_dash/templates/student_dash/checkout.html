{% extends 'base.html' %}

{% block title %}Checkout - {{ course.title }} - NMTSA Learning{% endblock %}

{% block content %}
<div style="display: flex; gap: var(--spacing-xl);">
    <!-- Simple Navigation -->
    <nav style="width: 250px; min-height: calc(100vh - 200px); background: var(--bg-card); border-right: 1px solid var(--border-color); padding: var(--spacing-lg);">
        <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="margin-bottom: var(--spacing-sm);">
                <a href="/student/" style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 6px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
            </li>
            <li style="margin-bottom: var(--spacing-sm);">
                <a href="/student/courses/" style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 6px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    <span>My Courses</span>
                </a>
            </li>
            <li style="margin-bottom: var(--spacing-sm);">
                <a href="/student/catalog/" style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); text-decoration: none; color: #7FA8C9; border-radius: 6px; background: #E8F1F8; font-weight: 600;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <span>Browse Catalog</span>
                </a>
            </li>
            <li style="margin-bottom: var(--spacing-sm);">
                <a href="/auth/profile/settings/" style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); text-decoration: none; color: var(--text-primary); border-radius: 6px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6m8.66-10a9 9 0 0 1 0 8m-17.32 0a9 9 0 0 1 0-8"/>
                    </svg>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div style="flex: 1; max-width: 900px;">
        <!-- Breadcrumbs -->
        <nav aria-label="Breadcrumb" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md) 0;">
            <ol style="list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; align-items: center; gap: var(--spacing-sm); font-size: calc(0.875rem * var(--font-scale));">
                <li style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <a href="/student/" style="color: var(--text-secondary); text-decoration: none; transition: color 0.2s;" onmouseenter="this.style.color='var(--primary)'" onmouseleave="this.style.color='var(--text-secondary)'">Home</a>
                    <svg width="14" height="14" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </li>
                <li style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <a href="/student/catalog/" style="color: var(--text-secondary); text-decoration: none; transition: color 0.2s;" onmouseenter="this.style.color='var(--primary)'" onmouseleave="this.style.color='var(--text-secondary)'">Course Catalog</a>
                    <svg width="14" height="14" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </li>
                <li style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <a href="{% url 'student_course_detail' course.id %}" style="color: var(--text-secondary); text-decoration: none; transition: color 0.2s;" onmouseenter="this.style.color='var(--primary)'" onmouseleave="this.style.color='var(--text-secondary)'">{{ course.title }}</a>
                    <svg width="14" height="14" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </li>
                <li style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="color: var(--text-primary); font-weight: 600;" aria-current="page">Checkout</span>
                </li>
            </ol>
        </nav>

        <!-- Back Link -->
        <a href="{% url 'student_course_detail' course.id %}"
           style="display: inline-flex; align-items: center; gap: var(--spacing-sm); color: var(--text-secondary); text-decoration: none; margin-bottom: var(--spacing-xl); font-size: calc(0.875rem * var(--font-scale)); transition: color 0.2s;">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="m15 18-6-6 6-6"/>
            </svg>
            Back to Course
        </a>

        <!-- Checkout Container -->
        <div style="display: grid; grid-template-columns: 1fr 400px; gap: var(--spacing-2xl);">
            <!-- Payment Form -->
            <div style="background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: var(--spacing-2xl); box-shadow: var(--shadow-md);">
                <h1 style="margin-bottom: var(--spacing-md); font-size: calc(1.75rem * var(--font-scale));">Complete Your Enrollment</h1>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-2xl);">
                    You're almost there! Complete your payment to get instant access to the course.
                </p>

                <form method="POST" action="{% url 'student_process_checkout' course.id %}" id="checkout-form">
                    {% csrf_token %}

                    <!-- Billing Information -->
                    <div style="margin-bottom: var(--spacing-2xl);">
                        <h2 style="margin-bottom: var(--spacing-lg); font-size: calc(1.25rem * var(--font-scale)); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border-color);">
                            Billing Information
                        </h2>

                        <div style="display: grid; gap: var(--spacing-lg);">
                            <!-- Full Name -->
                            <div>
                                <label for="full_name" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text-primary);">
                                    Full Name <span style="color: #EF4444;">*</span>
                                </label>
                                <input type="text"
                                       id="full_name"
                                       name="full_name"
                                       required
                                       value="{{ request.session.user.first_name }} {{ request.session.user.last_name }}"
                                       style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: calc(1rem * var(--font-scale)); background: var(--bg-primary); color: var(--text-primary);">
                            </div>

                            <!-- Email -->
                            <div>
                                <label for="email" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text-primary);">
                                    Email Address <span style="color: #EF4444;">*</span>
                                </label>
                                <input type="email"
                                       id="email"
                                       name="email"
                                       required
                                       value="{{ request.session.user.email }}"
                                       style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: calc(1rem * var(--font-scale)); background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Details -->
                    <div style="margin-bottom: var(--spacing-2xl);">
                        <h2 style="margin-bottom: var(--spacing-lg); font-size: calc(1.25rem * var(--font-scale)); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border-color);">
                            Payment Details
                        </h2>

                        <div style="display: grid; gap: var(--spacing-lg);">
                            <!-- Card Number -->
                            <div>
                                <label for="card_number" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text-primary);">
                                    Card Number <span style="color: #EF4444;">*</span>
                                </label>
                                <input type="text"
                                       id="card_number"
                                       name="card_number"
                                       placeholder="1234 5678 9012 3456"
                                       maxlength="19"
                                       required
                                       style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: calc(1rem * var(--font-scale)); background: var(--bg-primary); color: var(--text-primary);">
                            </div>

                            <!-- Expiry and CVV -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                                <div>
                                    <label for="expiry" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text-primary);">
                                        Expiry Date <span style="color: #EF4444;">*</span>
                                    </label>
                                    <input type="text"
                                           id="expiry"
                                           name="expiry"
                                           placeholder="MM/YY"
                                           maxlength="5"
                                           required
                                           style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: calc(1rem * var(--font-scale)); background: var(--bg-primary); color: var(--text-primary);">
                                </div>

                                <div>
                                    <label for="cvv" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text-primary);">
                                        CVV <span style="color: #EF4444;">*</span>
                                    </label>
                                    <input type="text"
                                           id="cvv"
                                           name="cvv"
                                           placeholder="123"
                                           maxlength="4"
                                           required
                                           style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: calc(1rem * var(--font-scale)); background: var(--bg-primary); color: var(--text-primary);">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Notice -->
                    <div style="background: #EFF6FF; border: 1px solid #BFDBFE; border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); display: flex; gap: var(--spacing-md);">
                        <svg width="20" height="20" fill="none" stroke="#3B82F6" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink: 0; margin-top: 2px;">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        <p style="color: #1E40AF; font-size: calc(0.875rem * var(--font-scale)); line-height: 1.6; margin: 0;">
                            Your payment information is secure. We use industry-standard encryption to protect your data.
                        </p>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit"
                            id="submit-btn"
                            style="width: 100%; padding: var(--spacing-lg); background: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-size: calc(1.125rem * var(--font-scale)); font-weight: 600; cursor: pointer; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm);">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Complete Payment - ${{ course.price }}
                    </button>
                </form>
            </div>

            <!-- Order Summary -->
            <div>
                <div style="background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: var(--spacing-xl); box-shadow: var(--shadow-md); position: sticky; top: var(--spacing-xl);">
                    <h2 style="margin-bottom: var(--spacing-lg); font-size: calc(1.25rem * var(--font-scale));">Order Summary</h2>

                    <!-- Course Info -->
                    <div style="margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-xl); border-bottom: 1px solid var(--border-color);">
                        <div style="width: 100%; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);"></div>

                        <h3 style="margin-bottom: var(--spacing-sm); font-size: calc(1rem * var(--font-scale)); line-height: 1.4;">
                            {{ course.title }}
                        </h3>

                        <p style="color: var(--text-secondary); font-size: calc(0.875rem * var(--font-scale)); margin-bottom: var(--spacing-sm);">
                            By {{ course.published_by.get_full_name }}
                        </p>

                        <div style="display: flex; align-items: center; gap: var(--spacing-md); color: var(--text-secondary); font-size: calc(0.75rem * var(--font-scale));">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                </svg>
                                {{ course.num_enrollments }} students
                            </span>
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div style="margin-bottom: var(--spacing-lg);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md); color: var(--text-secondary);">
                            <span>Course Price:</span>
                            <span>${{ course.price }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: var(--spacing-md); border-top: 1px solid var(--border-color); font-weight: 700; font-size: calc(1.25rem * var(--font-scale));">
                            <span>Total:</span>
                            <span style="color: var(--primary);">${{ course.price }}</span>
                        </div>
                    </div>

                    <!-- What's Included -->
                    <div style="background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--spacing-lg);">
                        <h4 style="margin-bottom: var(--spacing-md); font-size: calc(0.875rem * var(--font-scale)); font-weight: 600;">
                            What's Included:
                        </h4>
                        <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            <li style="display: flex; align-items: start; gap: var(--spacing-sm); font-size: calc(0.875rem * var(--font-scale)); color: var(--text-secondary);">
                                <svg width="16" height="16" fill="none" stroke="#66BB6A" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink: 0; margin-top: 2px;">
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                Lifetime access to all course materials
                            </li>
                            <li style="display: flex; align-items: start; gap: var(--spacing-sm); font-size: calc(0.875rem * var(--font-scale)); color: var(--text-secondary);">
                                <svg width="16" height="16" fill="none" stroke="#66BB6A" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink: 0; margin-top: 2px;">
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                Certificate of completion
                            </li>
                            <li style="display: flex; align-items: start; gap: var(--spacing-sm); font-size: calc(0.875rem * var(--font-scale)); color: var(--text-secondary);">
                                <svg width="16" height="16" fill="none" stroke="#66BB6A" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink: 0; margin-top: 2px;">
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                Learn at your own pace
                            </li>
                            <li style="display: flex; align-items: start; gap: var(--spacing-sm); font-size: calc(0.875rem * var(--font-scale)); color: var(--text-secondary);">
                                <svg width="16" height="16" fill="none" stroke="#66BB6A" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink: 0; margin-top: 2px;">
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                Access on mobile and desktop
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Format card number input
document.getElementById('card_number').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    e.target.value = formattedValue;
});

// Format expiry date input
document.getElementById('expiry').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
    }
    e.target.value = value;
});

// Only allow numbers in CVV
document.getElementById('cvv').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});

// Form submission handling
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.6';
    submitBtn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" opacity="0.25"/><path d="M4 12a8 8 0 0 1 8-8"/></svg> Processing...';
});
</script>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
